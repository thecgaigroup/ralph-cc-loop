# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What is Ralph?

Ralph is an autonomous AI agent loop that runs Claude Code CLI repeatedly to implement PRD items. Each iteration spawns a fresh Claude Code instance with clean context - the only memory between iterations is git history, `progress.txt`, and `prd.json`.

## Architecture: Run From Here, Point At Projects

**Critical**: Ralph runs on a local machine and operates on projects accessible from that machine.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOCAL MACHINE                                              â”‚
â”‚                                                             â”‚
â”‚  ~/tools/ralph-claude-code/     (Ralph install directory)  â”‚
â”‚  â”œâ”€â”€ ralph.sh                   â† Run from here            â”‚
â”‚  â”œâ”€â”€ prompt.md                  â† Instructions for Claude  â”‚
â”‚  â””â”€â”€ .claude-plugin/skills/     â† 13 skills (see below)    â”‚
â”‚                                                             â”‚
â”‚  ~/Projects/my-app/             (Target project)           â”‚
â”‚  â”œâ”€â”€ prd.json                   â† Ralph reads this         â”‚
â”‚  â”œâ”€â”€ progress.txt               â† Ralph writes here        â”‚
â”‚  â”œâ”€â”€ ralph-output.log           â† Full Claude output       â”‚
â”‚  â””â”€â”€ src/...                    â† Ralph modifies code      â”‚
â”‚                                                             â”‚
â”‚  ~/Projects/other-project/      (Another target project)   â”‚
â”‚  â”œâ”€â”€ prd.json                                               â”‚
â”‚  â””â”€â”€ ...                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Principles

1. **Run from Ralph directory**: Always execute `./ralph.sh` from the Ralph install location
2. **Point at target projects**: Pass the project path as an argument: `./ralph.sh ~/Projects/my-app`
3. **Multiple projects**: Run separate terminals for each project - they don't share state
4. **File attribution**: Files Ralph creates are clearly marked (see File Naming below)

### File Naming Conventions

**In target project** (Ralph-generated files):
- `progress.txt` - Starts with `# Ralph Progress Log`
- `ralph-output.log` - Starts with `# Ralph Output Log`
- Commits include `ğŸ¤– Generated by Ralph`
- PRs include `ğŸ¤– Generated by Ralph` in the body

## Running Ralph

```bash
# Run against a project directory (requires existing prd.json)
./ralph.sh ~/Projects/my-app        # 10 iterations (default)
./ralph.sh ~/Projects/my-app 20     # 20 iterations

# Auto-generate PRD from GitHub issues, then run
./ralph.sh --from-issues ~/Projects/my-app --label bug
./ralph.sh --from-issues ~/Projects/my-app --label bug,feature 20
./ralph.sh --from-issues ~/Projects/my-app --issue 13,14,15
./ralph.sh --from-issues ~/Projects/my-app --milestone v2.0

# Check status
./ralph.sh status ~/Projects/my-app
```

### From-Issues Options

| Option | Description |
|--------|-------------|
| `--label <labels>` | Filter issues by label (comma-separated) |
| `--issue <numbers>` | Specific issues to process (comma-separated) |
| `--milestone <name>` | Filter issues by milestone |
| `--repo <owner/repo>` | GitHub repository (auto-detected if not specified) |
| `--mode <mode>` | PRD mode: `feature` or `backlog` (default: backlog) |

## Prerequisites

| Requirement | Install | Purpose |
|-------------|---------|---------|
| `jq` | `brew install jq` | JSON parsing |
| `claude` | [Claude Code docs](https://docs.anthropic.com/en/docs/claude-code) | AI agent |
| `gh` | `brew install gh` | GitHub CLI |
| `prd.json` | Create in project | Task list |

### GitHub Authentication

Ralph uses `gh` CLI for GitHub operations (PRs, issues). Authenticate once:

```bash
gh auth login
# Follow prompts to authenticate with GitHub
```

### Repository Detection

The repo is determined in this order:
1. `githubRepo` field in prd.json
2. Auto-detected from git remote: `gh repo view --json nameWithOwner`
3. Current directory's git remote (fallback)

## Architecture

| File | Purpose |
|------|---------|
| `ralph.sh` | Bash loop that spawns Claude Code instances with `--print --dangerously-skip-permissions` |
| `prompt.md` | Instructions fed to each Claude Code instance |
| `.claude-plugin/` | Plugin manifest (v2.1.0) and 13 skills |

### Per-Project Files (created in target project)

| File | Purpose |
|------|---------|
| `prd.json` | User stories with `passes` status |
| `progress.txt` | Append-only learnings for future iterations |
| `ralph-output.log` | Full Claude output from all iterations |
| `.last-branch` | Tracks current branch for archiving |
| `archive/` | Previous run archives |

### Auto-Created Files Detail

**progress.txt** - Created on first run with project header. Append-onlyâ€”Ralph never deletes content.

**ralph-output.log** - Complete Claude output from every iteration. Useful for debugging.

**.last-branch** - Contains current PRD's `branchName`. Triggers archiving when value changes.

**archive/** - When Ralph detects a new PRD (different `branchName`), it archives the previous run:
```
archive/
â””â”€â”€ project-name/
    â””â”€â”€ 2026-01-10-feature-name/
        â”œâ”€â”€ prd.json
        â”œâ”€â”€ progress.txt
        â””â”€â”€ ralph-output.log
```

### Environment Variables

Ralph does not use any environment variables. All configuration comes from:
- Command-line arguments (`./ralph.sh [project] [iterations]`)
- The `prd.json` file in the target project

## Modes

Ralph supports two modes set via the `mode` field in prd.json:

| Mode | Branching | PRs | Use Case |
|------|-----------|-----|----------|
| `feature` (default) | Single branch | One PR at end | Cohesive feature implementation |
| `backlog` | Branch per story/issue | PR per story/issue | Independent tasks, bugs, tech debt |

### Feature Mode
```json
{ "mode": "feature", "branchName": "ralph/my-feature" }
```
All stories go to one branch, one PR created when complete.

### Backlog Mode
```json
{ "mode": "backlog", "baseBranch": "main" }
```
Each story (or issue) gets its own branch (`ralph/issue-13`), PR created after each.

## PRD Format

```json
{
  "project": "Name",
  "mode": "feature",
  "branchName": "ralph/feature-name",
  "baseBranch": "main",
  "description": "What this PRD accomplishes",
  "githubRepo": "owner/repo",
  "githubIssues": [13, 14],
  "plugins": { "recommended": [], "optional": [] },
  "userStories": [
    {
      "id": "GH-13-1",
      "githubIssue": 13,
      "title": "Task title",
      "description": "User story format",
      "acceptanceCriteria": ["..."],
      "files": ["src/file.ts"],
      "dependsOn": ["US-000"],
      "priority": 1,
      "passes": false,
      "notes": ""
    }
  ]
}
```

### GitHub Integration

- `githubRepo`: Target repository for PR creation
- `githubIssues`: Array of issue numbers this PRD addresses
- `githubIssue` (per story): Links commits to specific issues
- When complete, Ralph creates a PR with `Closes #X` for each issue

### Story Dependencies

- `dependsOn` specifies story IDs that must pass before this story is eligible
- Ralph picks the highest-priority eligible story (lowest priority number, all dependencies met)
- Use dependencies when a story requires code/schema from another story

## Key Behaviors

- **One story per iteration**: Ralph implements exactly one user story, then commits and updates `prd.json`
- **Quality gates**: All commits must pass typecheck/lint/test before committing
- **Browser verification**: Best-effort for frontend stories - skipped gracefully if tools unavailable
- **GitHub integration**: Commits reference issues (`feat(#13): ...`), PRs include `Closes #X`
- **Completion signal**: When all stories pass, create PR and output `<promise>COMPLETE</promise>`

### Browser Testing Fallback

Browser verification is attempted but not required. Stories complete if:
- Code passes typecheck/lint/test
- Implementation matches acceptance criteria

Common skip reasons (logged to progress.txt):
- `Browser is already in use` - Playwright conflict
- `ERR_CONNECTION_REFUSED` - Dev server not running
- MCP tools not available

## Skills

Ralph includes 13 skills organized into five categories:

### Core Workflow
| Skill | Purpose |
|-------|---------|
| `/prd` | Interactively create a PRD by breaking down a feature |
| `/review-issues` | Review GitHub issues and generate PRD (scans codebase for context) |
| `/review-prs` | Review, approve, and merge GitHub PRs |

### Quality & Audit
| Skill | Purpose |
|-------|---------|
| `/qa-audit` | Production readiness audit with full remediation |
| `/test-coverage` | Find untested code and generate tests |
| `/a11y-audit` | WCAG accessibility audit and remediation |
| `/perf-audit` | Performance profiling and optimization |

### Security
| Skill | Purpose |
|-------|---------|
| `/security-audit` | OWASP Top 10, secrets detection, dependency vulnerabilities |

### Maintenance
| Skill | Purpose |
|-------|---------|
| `/deps-update` | Update dependencies, fix vulnerabilities, create PRs |
| `/refactor` | Detect code smells, reduce complexity, apply patterns |
| `/migrate` | Framework/version migration (React, Node, ESM, etc.) |

### Documentation
| Skill | Purpose |
|-------|---------|
| `/docs-gen` | Generate/update README, API docs, architecture docs |
| `/onboard` | Create new developer onboarding documentation |

### Examples
```bash
claude /review-issues --repo owner/repo --issue 13,14,15
claude /review-issues --repo owner/repo --label bug
claude /review-prs --auto-merge --dependabot-only
claude /qa-audit ~/Projects/my-app --env staging
claude /deps-update ~/Projects/my-app
claude /test-coverage ~/Projects/my-app
```

## Scheduling Ralph (macOS launchd)

To run Ralph automatically on a schedule, create a launchd plist:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.ralph.myproject</string>
    <key>ProgramArguments</key>
    <array>
        <string>/path/to/ralph-cc-loop/ralph.sh</string>
        <string>--from-issues</string>
        <string>/path/to/myproject</string>
        <string>--label</string>
        <string>bug,feature</string>
    </array>
    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>9</integer>
        <key>Minute</key>
        <integer>0</integer>
    </dict>
    <key>StandardOutPath</key>
    <string>/Users/you/logs/ralph-myproject.log</string>
    <key>StandardErrorPath</key>
    <string>/Users/you/logs/ralph-myproject.log</string>
    <key>WorkingDirectory</key>
    <string>/path/to/ralph-cc-loop</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/usr/local/bin:/usr/bin:/bin:/opt/homebrew/bin</string>
    </dict>
</dict>
</plist>
```

**Install:**
```bash
cp com.ralph.myproject.plist ~/Library/LaunchAgents/
launchctl load ~/Library/LaunchAgents/com.ralph.myproject.plist
```

**Uninstall:**
```bash
launchctl unload ~/Library/LaunchAgents/com.ralph.myproject.plist
rm ~/Library/LaunchAgents/com.ralph.myproject.plist
```

## Modifying Ralph

- Edit `prompt.md` to change what instructions Claude receives each iteration
- Edit `ralph.sh` to change the loop mechanics, argument parsing, or status display
- Add new skills in `skills/` directory
