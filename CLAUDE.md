# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What is Ralph?

Ralph is an autonomous AI agent loop that runs Claude Code CLI repeatedly to implement PRD items. Each iteration spawns a fresh Claude Code instance with clean context - the only memory between iterations is git history, `progress.txt`, and `prd.json`.

## Architecture: Run From Here, Point At Projects

**Critical**: Ralph runs on a local machine and operates on projects accessible from that machine.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOCAL MACHINE                                              â”‚
â”‚                                                             â”‚
â”‚  ~/tools/ralph-claude-code/     (Ralph install directory)  â”‚
â”‚  â”œâ”€â”€ ralph.sh                   â† Run from here            â”‚
â”‚  â”œâ”€â”€ prompt.md                                              â”‚
â”‚  â”œâ”€â”€ skills/                                                â”‚
â”‚  â””â”€â”€ logs/                      â† Project-specific logs    â”‚
â”‚      â”œâ”€â”€ my-app.log                                         â”‚
â”‚      â””â”€â”€ other-project.log                                  â”‚
â”‚                                                             â”‚
â”‚  ~/Projects/my-app/             (Target project)           â”‚
â”‚  â”œâ”€â”€ prd.json                   â† Ralph reads this         â”‚
â”‚  â”œâ”€â”€ progress.txt               â† Ralph writes here        â”‚
â”‚  â””â”€â”€ src/...                    â† Ralph modifies code      â”‚
â”‚                                                             â”‚
â”‚  ~/Projects/other-project/      (Another target project)   â”‚
â”‚  â”œâ”€â”€ prd.json                                               â”‚
â”‚  â””â”€â”€ ...                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Principles

1. **Run from Ralph directory**: Always execute `./ralph.sh` from the Ralph install location
2. **Point at target projects**: Pass the project path as an argument: `./ralph.sh ~/Projects/my-app`
3. **Multiple projects**: Run separate terminals for each project - they don't share state
4. **File attribution**: Files Ralph creates are clearly marked (see File Naming below)

### File Naming Conventions

**In Ralph directory** (logs, archives):
- Prefix with project name: `my-app.log`, `my-app-2024-01-10.archive`
- Or use subdirectories: `logs/my-app/`, `archive/my-app/`

**In target project** (Ralph-generated files):
- `progress.txt` - Starts with `# Ralph Progress Log`
- `ralph-output.log` - Starts with `# Ralph Output Log`
- Commits include `ğŸ¤– Generated by Ralph` or similar attribution

## Running Ralph

```bash
# Run against a project directory
./ralph.sh ~/Projects/my-app        # 10 iterations (default)
./ralph.sh ~/Projects/my-app 20     # 20 iterations

# Check status
./ralph.sh status ~/Projects/my-app
```

## Prerequisites

| Requirement | Install | Purpose |
|-------------|---------|---------|
| `jq` | `brew install jq` | JSON parsing |
| `claude` | [Claude Code docs](https://docs.anthropic.com/claude-code) | AI agent |
| `gh` | `brew install gh` | GitHub CLI |
| `prd.json` | Create in project | Task list |

### GitHub Authentication

Ralph uses `gh` CLI for GitHub operations (PRs, issues). Authenticate once:

```bash
gh auth login
# Follow prompts to authenticate with GitHub
```

### Repository Detection

The repo is determined in this order:
1. `githubRepo` field in prd.json
2. Auto-detected from git remote: `gh repo view --json nameWithOwner`
3. Current directory's git remote (fallback)

## Architecture

| File | Purpose |
|------|---------|
| `ralph.sh` | Bash loop that spawns Claude Code instances with `--print --dangerously-skip-permissions` |
| `prompt.md` | Instructions fed to each Claude Code instance |
| `skills/prd.md` | Skill for generating `prd.json` files interactively |

### Per-Project Files (created in target project)

| File | Purpose |
|------|---------|
| `prd.json` | User stories with `passes` status |
| `progress.txt` | Append-only learnings for future iterations |
| `ralph-output.log` | Full Claude output from all iterations |

## Modes

Ralph supports two modes set via the `mode` field in prd.json:

| Mode | Branching | PRs | Use Case |
|------|-----------|-----|----------|
| `feature` (default) | Single branch | One PR at end | Cohesive feature implementation |
| `backlog` | Branch per story/issue | PR per story/issue | Independent tasks, bugs, tech debt |

### Feature Mode
```json
{ "mode": "feature", "branchName": "ralph/my-feature" }
```
All stories go to one branch, one PR created when complete.

### Backlog Mode
```json
{ "mode": "backlog", "baseBranch": "main" }
```
Each story (or issue) gets its own branch (`ralph/issue-13`), PR created after each.

## PRD Format

```json
{
  "project": "Name",
  "mode": "feature",
  "branchName": "ralph/feature-name",
  "baseBranch": "main",
  "description": "What this PRD accomplishes",
  "githubRepo": "owner/repo",
  "githubIssues": [13, 14],
  "plugins": { "recommended": [], "optional": [] },
  "userStories": [
    {
      "id": "GH-13-1",
      "githubIssue": 13,
      "title": "Task title",
      "description": "User story format",
      "acceptanceCriteria": ["..."],
      "files": ["src/file.ts"],
      "dependsOn": ["US-000"],
      "priority": 1,
      "passes": false,
      "notes": ""
    }
  ]
}
```

### GitHub Integration

- `githubRepo`: Target repository for PR creation
- `githubIssues`: Array of issue numbers this PRD addresses
- `githubIssue` (per story): Links commits to specific issues
- When complete, Ralph creates a PR with `Closes #X` for each issue

### Story Dependencies

- `dependsOn` specifies story IDs that must pass before this story is eligible
- Ralph picks the highest-priority eligible story (lowest priority number, all dependencies met)
- Use dependencies when a story requires code/schema from another story

## Key Behaviors

- **One story per iteration**: Ralph implements exactly one user story, then commits and updates `prd.json`
- **Quality gates**: All commits must pass typecheck/lint/test before committing
- **Browser verification**: Best-effort for frontend stories - skipped gracefully if tools unavailable
- **GitHub integration**: Commits reference issues (`feat(#13): ...`), PRs include `Closes #X`
- **Completion signal**: When all stories pass, create PR and output `<promise>COMPLETE</promise>`

### Browser Testing Fallback

Browser verification is attempted but not required. Stories complete if:
- Code passes typecheck/lint/test
- Implementation matches acceptance criteria

Common skip reasons (logged to progress.txt):
- `Browser is already in use` - Playwright conflict
- `ERR_CONNECTION_REFUSED` - Dev server not running
- MCP tools not available

## Skills

| Skill | Purpose |
|-------|---------|
| `/prd` | Interactively create a PRD by breaking down a feature |
| `/plan` | Generate PRD from GitHub issues (scans codebase for context) |
| `/review-prs` | Review, approve, and merge GitHub PRs |

Example:
```bash
claude /plan --repo owner/repo --issue 13,14,15
claude /plan --repo owner/repo --label bug
claude /plan --repo owner/repo --milestone v2.0
claude /review-prs --auto-merge --dependabot-only
```

## Modifying Ralph

- Edit `prompt.md` to change what instructions Claude receives each iteration
- Edit `ralph.sh` to change the loop mechanics, argument parsing, or status display
- Add new skills in `skills/` directory
